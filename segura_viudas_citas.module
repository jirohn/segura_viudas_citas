<?php

use Drupal\node\Entity\Node;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Mail\MailManagerInterface;
use Drupal\Core\Mail\Plugin\Mail\PhpMail;
use Drupal\Core\Render\Markup;
use Symfony\Component\DependencyInjection\ContainerInterface;

/**
 * Implements hook_theme_suggestions_page_alter().
 */
function segura_viudas_citas_theme_suggestions_page_alter(array &$suggestions, array $variables) {
  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name === 'segura_viudas_citas.citas_form') {
    $suggestions[] = 'page__citas_form';
  }
}



/**
 * Implements hook_theme().
 */
function segura_viudas_citas_theme($existing, $type, $theme, $path) {

  return [
    'segura_viudas_cita_solicitar_form' => [
      'variables' => ['form' => NULL],
      'template' => 'segura-viudas-cita-solicitar-form',
      'path' => $path . '/templates',
    ],
    'citas_admin_page' => [
      'template' => 'citas-admin',
      'path' => $path . '/templates',
    ],
    'gestion_citas' => [
      'variables' => ['title' => NULL, 'rows' => []],
      'template' => 'gestion-citas',
    ],
    'node__citas' => [
      'base hook' => 'node',
      'template' => 'node--citas',
      'path' => $path . '/templates',
    ],
  ];
}

/**
 * Implements hook_entity_view().
 */
function segura_viudas_citas_entity_view(array &$build, \Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display, $view_mode) {
  if ($entity->getEntityTypeId() === 'node' && $entity->bundle() === 'citas' && $view_mode === 'full') {
    $url = \Drupal\Core\Url::fromRoute('segura_viudas_citas.admin_citas', ['node' => $entity->id()]);
    $response = new \Symfony\Component\HttpFoundation\RedirectResponse($url->toString());
    $response->send();
    $variables['node'] = $entity;
    exit;
  }
}

/**
 * Implements hook_preprocess_page().
 */
function segura_viudas_citas_preprocess_page(&$variables) {
  $current_user = \Drupal::currentUser();
  if ($current_user->isAuthenticated()) {
    $user = \Drupal\user\Entity\User::load($current_user->id());
    $last_access = $user->getLastAccessedTime();
    // Si quieres la fecha en un formato específico, puedes usar el servicio de fecha de Drupal.
    $formatted_date = \Drupal::service('date.formatter')->format($last_access, 'custom', 'd/m/Y H:i');
    $variables['last_access'] = $formatted_date;
  }
}


/**
 * Implementa hook_preprocess_HOOK() para pasar variables a Twig.
 */
function segura_viudas_citas_preprocess_node(&$variables) {
  $node = $variables['node'];

  // Verifica si el nodo tiene un autor.
  if ($node->hasField('uid')) {
    $author = $node->get('uid')->entity;

    if ($author) {
      // Obtiene el nombre de usuario del autor.
      $variables['author_name'] = $author->getDisplayName();
      $variables['author_acre'] = $author->get('field_acreedor')->value;
      $variables['author_cif_empresa'] = $author->get('field_cif_empresa')->value;
      $variables['author_telefono'] = $author->get('field_telefono')->value;
      $variables['author_email'] = $author->getEmail();
    }
  }
  if ($node->getType() == 'citas') {
    $variables['#attached']['library'][] = 'segura_viudas_citas/citas_view';
    $variables['#attached']['library'][] = 'segura_viudas_citas/custom_admin_page_styles';
  }
}

// Al eliminar un contenido de tipo "Citas" manda un correo electrónico al autor de ese contenido

/**
 * Implements hook_ENTITY_TYPE_delete() for Cita entities.
 */
function mymodule_cita_delete(EntityInterface $entity, MailManagerInterface $mailManager) {
  $author = $entity->getOwner();
  $message = "Estimado(a) {$author->getDisplayName()}, tu Cita ha sido eliminada.";

  $body = [
    '#theme' => 'mymodule_cita_deleted_mail',
    '#message' => Markup::create($message),
  ];

  $message = \Drupal::service('renderer')->renderPlain($body);

  $params['message']['headers']['Content-Type'] = 'text/html; charset=UTF-8';
  $params['message']['body'] = $message;

  $mailManager->mail('system', 'mail', $author->getEmail(), $author->getPreferredLangcode(), $params, NULL, TRUE);
}

/**
 * Implements hook_theme().
 */
function mymodule_theme() {
  return [
    'mymodule_cita_deleted_mail' => [
      'variables' => [
        'message' => NULL,
      ],
    ],
  ];
}